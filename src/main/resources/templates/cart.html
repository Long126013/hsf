<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ccc;
            text-align: center;
        }

        .total {
            font-weight: bold;
            font-size: 18px;
            text-align: right;
        }

        .btn {
            padding: 6px 10px;
            cursor: pointer;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
        }

        .btn-remove {
            background-color: #f44336;
        }

        .qty-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .qty-btn {
            padding: 4px 8px;
            font-size: 14px;
            background-color: #ddd;
            color: black;
            border: 1px solid #aaa;
            cursor: pointer;
        }

        .qty-input {
            width: 50px;
            text-align: center;
            font-size: 14px;
            padding: 4px;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
    <script>
        function increaseQuantity(itemId) {
            window.location.href = '/cart/increase/' + itemId;
        }

        function decreaseQuantity(itemId) {
            window.location.href = '/cart/decrease/' + itemId;
        }

        function removeItem(itemId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) {
                window.location.href = '/cart/remove/' + itemId;
            }
        }

        function calculateTotal() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            let total = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const price = parseFloat(cb.getAttribute('data-price'));
                    const quantity = parseInt(cb.getAttribute('data-quantity'));
                    total += price * quantity;
                }
            });

            document.getElementById('total-price').innerText = total.toLocaleString('vi-VN') + ' VND';
        }

        // ‚úÖ CHECKOUT FUNCTION (included as requested)
        function checkout() {
            const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.');
                return;
            }

            fetch('/cart/checkout', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(selectedIds)
            })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.href = '/checkout-success';
                    } else {
                        return response.text().then(msg => alert(msg));
                    }
                });
        }

        window.addEventListener('DOMContentLoaded', () => {
            calculateTotal();
        });
    </script>
</head>
<body>

<h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<form th:action="@{/cart/save}" method="post">
    <!--<table id="cart-table">-->
    <table>
        <thead>
        <tr>
            <th>Ch·ªçn</th>
            <th>S·∫£n ph·∫©m</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T·ªïng</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${cart.items}">
            <td>
                <input type="checkbox" class="item-checkbox"
                       th:name="selectedItems"
                       th:value="${item.id}"
                       th:attr="data-price=${item.product.price}, data-quantity=${item.quantity}"
                       onchange="calculateTotal()"/>
            </td>

            <td th:text="${item.product.name}">Product Name</td>

            <td th:text="${#numbers.formatDecimal(item.product.price, 0, 'POINT', 0, 'POINT')} + ' VND'">100000 VND</td>

            <td>
                <button type="button" class="btn" th:onclick="'decreaseQuantity(' + ${item.id} + ')'">-</button>
                <span th:text="${item.quantity}">1</span>
                <button type="button" class="btn" th:onclick="'increaseQuantity(' + ${item.id} + ')'">+</button>
            </td>

            <td th:text="${#numbers.formatDecimal(item.quantity * item.product.price, 0, 'POINT', 0, 'POINT')} + ' VND'">
                0 VND
            </td>

            <!-- ‚úÖ Remove -->
            <td>
                <button type="button" class="btn" th:onclick="'removeItem(' + ${item.id} + ')'">X√≥a</button>
            </td>
        </tr>
        </tbody>
    </table>


    <h3 class="total">T·ªïng thanh to√°n: <div  id="total-price">T·ªïng c·ªông: 0 VND</div></h3>

    <button type="submit" class="btn">L∆∞u gi·ªè h√†ng</button>

    <button type="button" class="btn" onclick="checkout()">Thanh to√°n c√°c m·ª•c ƒë√£ ch·ªçn</button>

</form>
<!--<a href="/cart/export-pdf/${cart.id}'" class="btn btn-primary" target="_blank">-->
<!--    Xu·∫•t h√≥a ƒë∆°n-->
<!--</a>-->

</body>
</html>
